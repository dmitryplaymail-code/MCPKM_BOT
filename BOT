import logging
import os
import sqlite3
from datetime import datetime
from io import StringIO
import csv

from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    Application,
    CommandHandler,
    CallbackQueryHandler,
    MessageHandler,
    filters,
    ContextTypes,
    ConversationHandler
)

# ===================== –ù–ê–°–¢–†–û–ô–ö–ò =====================
BOT_TOKEN = "7417771181:AAHYtMKQFlN2SZqBUIfK7hvE4HCohn8QaDg"
ADMIN_ID = 5728828487  # –í–∞—à Telegram ID

# –§–∞–π–ª—ã –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è (—Å–æ–∑–¥–∞–π—Ç–µ –ø–∞–ø–∫—É files –∏ –ø–æ–ª–æ–∂–∏—Ç–µ —Ç—É–¥–∞ —Ñ–∞–π–ª—ã)
FILES = {
    'program': {'name': '–ü—Ä–æ–≥—Ä–∞–º–º–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è.pdf', 'path': 'files/program.pdf'},
    'presentation': {'name': '–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è.pptx', 'path': 'files/presentation.pptx'},
    'instructions': {'name': '–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.docx', 'path': 'files/instructions.docx'},
}

# –¢–µ–∫—Å—Ç—ã —Å–æ–æ–±—â–µ–Ω–∏–π
MESSAGES = {
    'welcome': (
        "üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –±–æ—Ç –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è!\n\n"
        "–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ:\n"
        "‚Ä¢ üìù –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ\n"
        "‚Ä¢ üìÅ –°–∫–∞—á–∞—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã\n"
        "‚Ä¢ ‚ùì –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä—É –ø–æ –æ—Ö—Ä–∞–Ω–µ —Ç—Ä—É–¥–∞\n"
        "‚Ä¢ üë§ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
    ),
    'already_registered': "‚úÖ –í—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã!",
    'registration_start': "–ù–∞—á–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é! –í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –§–ò–û:",
    'ask_company': "–û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–∞—à–µ–π –∫–æ–º–ø–∞–Ω–∏–∏:",
    'ask_position': "–í–≤–µ–¥–∏—Ç–µ –≤–∞—à—É –¥–æ–ª–∂–Ω–æ—Å—Ç—å:",
    'ask_email': "–í–≤–µ–¥–∏—Ç–µ –≤–∞—à email:",
    'ask_phone': "–í–≤–µ–¥–∏—Ç–µ –≤–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω:",
    'registration_complete': (
        "üéâ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n\n"
        "–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ:\n"
        "–§–ò–û: {full_name}\n"
        "–ö–æ–º–ø–∞–Ω–∏—è: {company}\n"
        "–î–æ–ª–∂–Ω–æ—Å—Ç—å: {position}\n"
        "Email: {email}\n"
        "–¢–µ–ª–µ—Ñ–æ–Ω: {phone}\n\n"
        "–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ —Å–∫–∞—á–∞—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∏–ª–∏ –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å."
    ),
    'ask_question_prompt': "–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä—É –ø–æ –æ—Ö—Ä–∞–Ω–µ —Ç—Ä—É–¥–∞:\n\n(–í–æ–ø—Ä–æ—Å –±—É–¥–µ—Ç –ø–µ—Ä–µ–¥–∞–Ω –∞–Ω–æ–Ω–∏–º–Ω–æ)",
    'question_received': "‚úÖ –í–∞—à –≤–æ–ø—Ä–æ—Å –ø–æ–ª—É—á–µ–Ω! –°–ø–∞—Å–∏–±–æ –∑–∞ —É—á–∞—Å—Ç–∏–µ!",
    'no_files': "üìÅ –§–∞–π–ª—ã —Å–∫–æ—Ä–æ –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã.",
    'file_sent': "üìÑ –í–æ—Ç –≤–∞—à —Ñ–∞–π–ª:",
    'no_info': "–í—ã –µ—â–µ –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã. –ù–∞–∂–º–∏—Ç–µ '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è'.",
}

# ===================== –ë–ê–ó–ê –î–ê–ù–ù–´–• =====================
class Database:
    def __init__(self, db_path='event_bot.db'):
        self.db_path = db_path
        self.init_db()
    
    def get_connection(self):
        conn = sqlite3.connect(self.db_path)
        conn.row_factory = sqlite3.Row
        return conn
    
    def init_db(self):
        with self.get_connection() as conn:
            # –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            conn.execute('''
                CREATE TABLE IF NOT EXISTS users (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    user_id INTEGER UNIQUE,
                    username TEXT,
                    full_name TEXT NOT NULL,
                    company TEXT NOT NULL,
                    position TEXT NOT NULL,
                    email TEXT NOT NULL,
                    phone TEXT NOT NULL,
                    registration_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                )
            ''')
            
            # –¢–∞–±–ª–∏—Ü–∞ –≤–æ–ø—Ä–æ—Å–æ–≤
            conn.execute('''
                CREATE TABLE IF NOT EXISTS questions (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    user_id INTEGER,
                    question_text TEXT NOT NULL,
                    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    status TEXT DEFAULT 'new'
                )
            ''')
            
            conn.commit()
    
    def add_user(self, user_data):
        with self.get_connection() as conn:
            try:
                conn.execute('''
                    INSERT INTO users (user_id, username, full_name, company, position, email, phone)
                    VALUES (?, ?, ?, ?, ?, ?, ?)
                ''', (
                    user_data['user_id'],
                    user_data.get('username'),
                    user_data['full_name'],
                    user_data['company'],
                    user_data['position'],
                    user_data['email'],
                    user_data['phone']
                ))
                conn.commit()
                return True
            except sqlite3.IntegrityError:
                return False
    
    def get_user(self, user_id):
        with self.get_connection() as conn:
            cursor = conn.execute('SELECT * FROM users WHERE user_id = ?', (user_id,))
            return cursor.fetchone()
    
    def is_user_registered(self, user_id):
        return self.get_user(user_id) is not None
    
    def add_question(self, user_id, question_text):
        with self.get_connection() as conn:
            conn.execute('''
                INSERT INTO questions (user_id, question_text)
                VALUES (?, ?)
            ''', (user_id, question_text))
            conn.commit()
    
    def get_stats(self):
        with self.get_connection() as conn:
            cursor = conn.execute('SELECT COUNT(*) as count FROM users')
            user_count = cursor.fetchone()['count']
            
            cursor = conn.execute('SELECT COUNT(*) as count FROM questions')
            question_count = cursor.fetchone()['count']
            
            cursor = conn.execute('SELECT COUNT(*) as count FROM questions WHERE status = "new"')
            new_questions = cursor.fetchone()['count']
            
            return {
                'users': user_count,
                'questions': question_count,
                'new_questions': new_questions
            }
    
    def get_all_users(self):
        with self.get_connection() as conn:
            cursor = conn.execute('SELECT * FROM users ORDER BY registration_date')
            return cursor.fetchall()
    
    def get_questions(self, status='new'):
        with self.get_connection() as conn:
            cursor = conn.execute('''
                SELECT q.*, u.full_name 
                FROM questions q
                LEFT JOIN users u ON q.user_id = u.user_id
                WHERE q.status = ?
                ORDER BY q.timestamp
            ''', (status,))
            return cursor.fetchall()

# –°–æ–∑–¥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
db = Database()

# ===================== –ö–õ–ê–í–ò–ê–¢–£–†–´ =====================
def get_main_menu():
    keyboard = [
        [InlineKeyboardButton("üìù –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è", callback_data='register')],
        [InlineKeyboardButton("üìÅ –ú–∞—Ç–µ—Ä–∏–∞–ª—ã", callback_data='materials')],
        [InlineKeyboardButton("‚ùì –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å", callback_data='ask_question')],
        [InlineKeyboardButton("üë§ –ú–æ—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è", callback_data='my_info')],
    ]
    return InlineKeyboardMarkup(keyboard)

def get_materials_menu():
    keyboard = []
    for key, file_info in FILES.items():
        keyboard.append([
            InlineKeyboardButton(f"üìÑ {file_info['name']}", callback_data=f"file_{key}")
        ])
    keyboard.append([InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data='back')])
    return InlineKeyboardMarkup(keyboard)

def get_back_button():
    keyboard = [[InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data='back')]]
    return InlineKeyboardMarkup(keyboard)

# ===================== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò =====================
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –¥–∏–∞–ª–æ–≥–æ–≤
REGISTER_NAME, REGISTER_COMPANY, REGISTER_POSITION, REGISTER_EMAIL, REGISTER_PHONE = range(5)
ASK_QUESTION = range(1)

# –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö
user_temp_data = {}

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    user = update.effective_user
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user.id} –∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞")
    
    await update.message.reply_text(
        MESSAGES['welcome'],
        reply_markup=get_main_menu()
    )

async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ –∫–Ω–æ–ø–∫–∏"""
    query = update.callback_query
    await query.answer()
    
    user_id = query.from_user.id
    data = query.data
    
    if data == 'register':
        return await handle_registration(query, user_id)
    elif data == 'materials':
        await query.edit_message_text(
            "üìö –í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è:",
            reply_markup=get_materials_menu()
        )
    elif data.startswith('file_'):
        await handle_file_download(query, data)
    elif data == 'ask_question':
        return await handle_ask_question(query)
    elif data == 'my_info':
        await handle_my_info(query, user_id)
    elif data == 'back':
        await query.edit_message_text(
            MESSAGES['welcome'],
            reply_markup=get_main_menu()
        )
        return ConversationHandler.END
    
    return ConversationHandler.END

async def handle_registration(query, user_id):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞—á–∞–ª–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏"""
    if db.is_user_registered(user_id):
        await query.edit_message_text(
            MESSAGES['already_registered'],
            reply_markup=get_back_button()
        )
        return ConversationHandler.END
    else:
        user_temp_data[user_id] = {}
        await query.edit_message_text(
            MESSAGES['registration_start'],
            reply_markup=get_back_button()
        )
        return REGISTER_NAME

async def handle_file_download(query, data):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é"""
    file_key = data.replace('file_', '')
    
    if file_key in FILES:
        file_info = FILES[file_key]
        file_path = file_info['path']
        
        if os.path.exists(file_path):
            await query.message.reply_document(
                document=open(file_path, 'rb'),
                filename=file_info['name'],
                caption=f"{MESSAGES['file_sent']} {file_info['name']}"
            )
        else:
            await query.message.reply_text(
                "‚ùå –§–∞–π–ª –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
            )
    else:
        await query.message.reply_text(MESSAGES['no_files'])

async def handle_ask_question(query):
    """–ù–∞—á–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –≤–æ–ø—Ä–æ—Å–∞"""
    await query.edit_message_text(
        MESSAGES['ask_question_prompt'],
        reply_markup=get_back_button()
    )
    return ASK_QUESTION

async def handle_my_info(query, user_id):
    """–ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ"""
    user_data = db.get_user(user_id)
    
    if user_data:
        info_text = (
            "üë§ –í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ:\n\n"
            f"–§–ò–û: {user_data['full_name']}\n"
            f"–ö–æ–º–ø–∞–Ω–∏—è: {user_data['company']}\n"
            f"–î–æ–ª–∂–Ω–æ—Å—Ç—å: {user_data['position']}\n"
            f"Email: {user_data['email']}\n"
            f"–¢–µ–ª–µ—Ñ–æ–Ω: {user_data['phone']}\n"
            f"–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {user_data['registration_date']}"
        )
    else:
        info_text = MESSAGES['no_info']
    
    await query.edit_message_text(
        info_text,
        reply_markup=get_back_button()
    )

# ===================== –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø =====================
async def register_name(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.message.from_user.id
    user_temp_data[user_id] = {'full_name': update.message.text}
    
    await update.message.reply_text(
        MESSAGES['ask_company'],
        reply_markup=get_back_button()
    )
    return REGISTER_COMPANY

async def register_company(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.message.from_user.id
    user_temp_data[user_id]['company'] = update.message.text
    
    await update.message.reply_text(
        MESSAGES['ask_position'],
        reply_markup=get_back_button()
    )
    return REGISTER_POSITION

async def register_position(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.message.from_user.id
    user_temp_data[user_id]['position'] = update.message.text
    
    await update.message.reply_text(
        MESSAGES['ask_email'],
        reply_markup=get_back_button()
    )
    return REGISTER_EMAIL

async def register_email(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.message.from_user.id
    user_temp_data[user_id]['email'] = update.message.text
    
    await update.message.reply_text(
        MESSAGES['ask_phone'],
        reply_markup=get_back_button()
    )
    return REGISTER_PHONE

async def register_phone(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.message.from_user.id
    user = update.message.from_user
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω
    user_temp_data[user_id]['phone'] = update.message.text
    user_temp_data[user_id]['user_id'] = user_id
    user_temp_data[user_id]['username'] = user.username
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    success = db.add_user(user_temp_data[user_id])
    
    if success:
        message = MESSAGES['registration_complete'].format(
            full_name=user_temp_data[user_id]['full_name'],
            company=user_temp_data[user_id]['company'],
            position=user_temp_data[user_id]['position'],
            email=user_temp_data[user_id]['email'],
            phone=user_temp_data[user_id]['phone']
        )
        
        # –û–ø–æ–≤–µ—â–∞–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        admin_message = (
            "üì• –ù–æ–≤–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è!\n\n"
            f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user.username or '–ë–µ–∑ username'}\n"
            f"ID: {user_id}\n"
            f"–§–ò–û: {user_temp_data[user_id]['full_name']}\n"
            f"–ö–æ–º–ø–∞–Ω–∏—è: {user_temp_data[user_id]['company']}"
        )
        await context.bot.send_message(chat_id=ADMIN_ID, text=admin_message)
        
        # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        user_temp_data.pop(user_id, None)
        
        await update.message.reply_text(
            message,
            reply_markup=get_main_menu()
        )
    else:
        await update.message.reply_text(
            "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏. –í–æ–∑–º–æ–∂–Ω–æ, –≤—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã.",
            reply_markup=get_main_menu()
        )
    
    return ConversationHandler.END

async def ask_question(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    user_id = update.message.from_user.id
    question_text = update.message.text
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–æ–ø—Ä–æ—Å –≤ –±–∞–∑—É
    db.add_question(user_id, question_text)
    
    # –û–ø–æ–≤–µ—â–∞–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    user = update.message.from_user
    admin_message = (
        "‚ùì –ù–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å –æ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–∞!\n\n"
        f"–û—Ç: {user.username or user.full_name}\n"
        f"ID: {user_id}\n\n"
        f"–í–æ–ø—Ä–æ—Å:\n{question_text}"
    )
    await context.bot.send_message(chat_id=ADMIN_ID, text=admin_message)
    
    await update.message.reply_text(
        MESSAGES['question_received'],
        reply_markup=get_main_menu()
    )
    
    return ConversationHandler.END

async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û—Ç–º–µ–Ω–∞ –¥–µ–π—Å—Ç–≤–∏—è"""
    user_id = update.message.from_user.id
    user_temp_data.pop(user_id, None)
    
    await update.message.reply_text(
        "–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.",
        reply_markup=get_main_menu()
    )
    return ConversationHandler.END

# ===================== –ê–î–ú–ò–ù-–ö–û–ú–ê–ù–î–´ =====================
async def admin_stats(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞)"""
    if update.effective_user.id != ADMIN_ID:
        await update.message.reply_text("‚õî –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
        return
    
    stats = db.get_stats()
    
    message = (
        "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–æ—Ç–∞:\n\n"
        f"üë• –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: {stats['users']}\n"
        f"‚ùì –í—Å–µ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤: {stats['questions']}\n"
        f"üÜï –ù–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤: {stats['new_questions']}"
    )
    
    await update.message.reply_text(message)

async def export_users(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–≠–∫—Å–ø–æ—Ä—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ CSV (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞)"""
    if update.effective_user.id != ADMIN_ID:
        return
    
    users = db.get_all_users()
    
    if not users:
        await update.message.reply_text("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞.")
        return
    
    # –°–æ–∑–¥–∞–µ–º CSV —Ñ–∞–π–ª
    output = StringIO()
    writer = csv.writer(output)
    
    # –ó–∞–≥–æ–ª–æ–≤–∫–∏
    writer.writerow(['ID', 'Username', '–§–ò–û', '–ö–æ–º–ø–∞–Ω–∏—è', '–î–æ–ª–∂–Ω–æ—Å—Ç—å', 'Email', '–¢–µ–ª–µ—Ñ–æ–Ω', '–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏'])
    
    # –î–∞–Ω–Ω—ã–µ
    for user in users:
        writer.writerow([
            user['user_id'],
            user['username'] or '',
            user['full_name'],
            user['company'],
            user['position'],
            user['email'],
            user['phone'],
            user['registration_date']
        ])
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª
    output.seek(0)
    await update.message.reply_document(
        document=output.getvalue().encode(),
        filename='participants.csv',
        caption=f"üë• –≠–∫—Å–ø–æ—Ä—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ ({len(users)} —á–µ–ª–æ–≤–µ–∫)"
    )

async def export_questions(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–≠–∫—Å–ø–æ—Ä—Ç –≤–æ–ø—Ä–æ—Å–æ–≤ –≤ CSV (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞)"""
    if update.effective_user.id != ADMIN_ID:
        return
    
    questions = db.get_questions(status='new')
    
    if not questions:
        await update.message.reply_text("–ù–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞.")
        return
    
    output = StringIO()
    writer = csv.writer(output)
    
    writer.writerow(['ID', '–§–ò–û', '–í–æ–ø—Ä–æ—Å', '–î–∞—Ç–∞', '–°—Ç–∞—Ç—É—Å'])
    
    for q in questions:
        writer.writerow([
            q['id'],
            q['full_name'] or '–ê–Ω–æ–Ω–∏–º',
            q['question_text'],
            q['timestamp'],
            q['status']
        ])
    
    output.seek(0)
    
    await update.message.reply_document(
        document=output.getvalue().encode(),
        filename='questions.csv',
        caption=f"‚ùì –≠–∫—Å–ø–æ—Ä—Ç –≤–æ–ø—Ä–æ—Å–æ–≤ ({len(questions)} –≤–æ–ø—Ä–æ—Å–æ–≤)"
    )

# ===================== –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø =====================
def main():
    """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞"""
    if not BOT_TOKEN:
        logger.error("‚ùå –¢–æ–∫–µ–Ω –±–æ—Ç–∞ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")
        return
    
    # –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    application = Application.builder().token(BOT_TOKEN).build()
    
    # ConversationHandler –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    registration_handler = ConversationHandler(
        entry_points=[CallbackQueryHandler(button_handler, pattern='^register$')],
        states={
            REGISTER_NAME: [MessageHandler(filters.TEXT & ~filters.COMMAND, register_name)],
            REGISTER_COMPANY: [MessageHandler(filters.TEXT & ~filters.COMMAND, register_company)],
            REGISTER_POSITION: [MessageHandler(filters.TEXT & ~filters.COMMAND, register_position)],
            REGISTER_EMAIL: [MessageHandler(filters.TEXT & ~filters.COMMAND, register_email)],
            REGISTER_PHONE: [MessageHandler(filters.TEXT & ~filters.COMMAND, register_phone)],
        },
        fallbacks=[
            CommandHandler('cancel', cancel),
            CallbackQueryHandler(cancel, pattern='^back$')
        ]
    )
    
    # ConversationHandler –¥–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤
    question_handler = ConversationHandler(
        entry_points=[CallbackQueryHandler(button_handler, pattern='^ask_question$')],
        states={
            ASK_QUESTION: [MessageHandler(filters.TEXT & ~filters.COMMAND, ask_question)],
        },
        fallbacks=[
            CommandHandler('cancel', cancel),
            CallbackQueryHandler(cancel, pattern='^back$')
        ]
    )
    
    # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    application.add_handler(CommandHandler('start', start))
    application.add_handler(CommandHandler('stats', admin_stats))
    application.add_handler(CommandHandler('export_users', export_users))
    application.add_handler(CommandHandler('export_questions', export_questions))
    application.add_handler(registration_handler)
    application.add_handler(question_handler)
    application.add_handler(CallbackQueryHandler(button_handler))
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    logger.info("ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
    print("=" * 50)
    print("‚úÖ –ë–û–¢ –ó–ê–ü–£–©–ï–ù –£–°–ü–ï–®–ù–û!")
    print(f"ü§ñ –¢–æ–∫–µ–Ω: {BOT_TOKEN[:10]}...")
    print(f"üëë –ê–¥–º–∏–Ω ID: {ADMIN_ID}")
    print("üîó –°—Å—ã–ª–∫–∞ –¥–ª—è –∫–∞–Ω–∞–ª–∞: https://t.me/–≤–∞—à_–±–æ—Ç?start=event_channel")
    print("=" * 50)
    
    application.run_polling(allowed_updates=Update.ALL_TYPES)

if __name__ == '__main__':
    main()
